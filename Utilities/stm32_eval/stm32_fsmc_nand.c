/***************************************************************
       
    ? ? ?:NAND FLASH????
    ?    ?:
    ?    ?:
	? ? ?:
    ????:
    ????:  
    ????: KEIL FOR ARM
    ????:  K9F1G08U0A??NAND
    ????: ????,?????
   ?:????????????,??????????????
    
***************************************************************/

/* Includes ------------------------------------------------------------------*/
#include "stm32_fsmc_nand.h"
//#include <stdio.h>

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/

#define FSMC_Bank_NAND     FSMC_Bank2_NAND
#define Bank_NAND_ADDR     Bank2_NAND_ADDR 
#define Bank2_NAND_ADDR    ((u32)0x70000000)

/* Private macro -------------------------------------------------------------*/


/* Private variables ---------------------------------------------------------*/
uint32 FlashCurrentWriteSectorAddr; //????????
uint32 FlashCurrentReadSectorAddr;  //????????
uint32 FlashNeedWriteBack; //???????

uint8 FlashSectorBuf[FLASH_SECTOR_SIZE]; //?????????

uint32 FlashBadBlockTable[2][FLASH_BAD_BLOCKS_REMAP+1]; //?????????
static uint32 FlashBadBlocksCount;  //??????
uint8 FlashRemapBlockStatus[FLASH_BAD_BLOCKS_REMAP+1]; //???????????
static uint32 FlashLastAccessAddr; //??????????
/* Private function prototypes -----------------------------------------------*/
/* Private functions ---------------------------------------------------------*/
/*******************************************************************************
* Function Name  : FSMC_NAND_Init
* Description    : Configures the FSMC and GPIOs to interface with the NAND memory.
*                  This function must be called before any write/read operation
*                  on the NAND.
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void FSMC_NAND_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStructure; 
  FSMC_NANDInitTypeDef FSMC_NANDInitStructure;
  FSMC_NAND_PCCARDTimingInitTypeDef  p;
  
  RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOD | RCC_APB2Periph_GPIOE | 
                         RCC_APB2Periph_GPIOF | RCC_APB2Periph_GPIOG, ENABLE);
  
/*-- GPIO Configuration ------------------------------------------------------*/
/* CLE, ALE, D0->D3, NOE, NWE and NCE2  NAND pin configuration  */
  GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_11 | GPIO_Pin_12 | GPIO_Pin_14 | GPIO_Pin_15 |  
                                 GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_4 | GPIO_Pin_5 | 
                                 GPIO_Pin_7;                                  
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;

  GPIO_Init(GPIOD, &GPIO_InitStructure); 

/* D4->D7 NAND pin configuration  */  
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_7 | GPIO_Pin_8 | GPIO_Pin_9 | GPIO_Pin_10;

  GPIO_Init(GPIOE, &GPIO_InitStructure);


/* NWAIT NAND pin configuration */
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6;   							 
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 // GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;

 // GPIO_Init(GPIOD, &GPIO_InitStructure); 

/* INT2 NAND pin configuration */  
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;   							 
  GPIO_Init(GPIOG, &GPIO_InitStructure);

  /*-- FSMC Configuration ------------------------------------------------------*/
  p.FSMC_SetupTime = 0x1;
  p.FSMC_WaitSetupTime = 0x3;
  p.FSMC_HoldSetupTime = 0x2;
  p.FSMC_HiZSetupTime = 0x1;

  FSMC_NANDInitStructure.FSMC_Bank = FSMC_Bank2_NAND;
  FSMC_NANDInitStructure.FSMC_Waitfeature = FSMC_Waitfeature_Enable;
  FSMC_NANDInitStructure.FSMC_MemoryDataWidth = FSMC_MemoryDataWidth_8b;
  FSMC_NANDInitStructure.FSMC_ECC = FSMC_ECC_Enable;
  FSMC_NANDInitStructure.FSMC_ECCPageSize = FSMC_ECCPageSize_512Bytes;
  FSMC_NANDInitStructure.FSMC_AddressLowMapping = FSMC_AddressLowMapping_Direct;
  FSMC_NANDInitStructure.FSMC_TCLRSetupTime = 0x00;
  FSMC_NANDInitStructure.FSMC_TARSetupTime = 0x00;
  FSMC_NANDInitStructure.FSMC_CommonSpaceTimingStruct = &p;
  FSMC_NANDInitStructure.FSMC_AttributeSpaceTimingStruct = &p;

  FSMC_NANDInit(&FSMC_NANDInitStructure);

  /* FSMC NAND Bank Cmd Test */
  FSMC_NANDCmd(FSMC_Bank2_NAND, ENABLE);
}

/********************************************************************
????:FLASH????
????:Val:???????
?    ?:??
?    ?:
********************************************************************/
void FlashWriteCommand(uint8 Cmd)
{
   *(uint8 *)(Bank_NAND_ADDR | CMD_AREA) = Cmd; 
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:FLASH????
????:Data:??????
?    ?:??
?    ?:
********************************************************************/
uint8 FlashReadDataByte()
{
   uint8 Data;
   Data = *(uint8 *)(Bank_NAND_ADDR);
   return  Data;
}

/********************************************************************
????:FLASH????
????:Data:??????
?    ?:??
?    ?:
********************************************************************/
void FlashWriteDataByte(uint8 Data)
{
   *(uint8 *)(Bank_NAND_ADDR | DATA_AREA)=Data;
}
/********************************************************************
????:FLASH????
????:Addr:??????
?    ?:??
?    ?:
********************************************************************/
void FlashWriteAddr(uint8 Addr)
{
	*(uint8 *)(Bank_NAND_ADDR | ADDR_AREA) = Addr;
}

/********************************************************************
????:??FLASH????
????:?
?    ?:??
?    ?:
********************************************************************/
void FlashWait()
{
	while(GPIO_ReadInputDataBit(GPIOG,GPIO_Pin_6) == Bit_RESET);  //?????  ?????
}
/////////////////////////End of function/////////////////////////////
/********************************************************************
????:?FLASH???????????
????:Addr:?????????
?    ?:??
?    ?:
********************************************************************/
void FlashWriteAddr4Byte(uint32 Addr)
{
 uint i;
 
 //??:?FLASH??????5bit???0
 //???16???5?
 Addr=((Addr<<5)&(~0xFFFF))|(Addr&0x07FF);

 for(i=0;i<4;i++) //????????
 {
  FlashWriteAddr(Addr);
  Addr>>=8;
 }

}
/////////////////////////End of function/////////////////////////////
/********************************************************************
????:?FLASH???????????
????:Addr:?????????
?    ?:??
?    ?:
********************************************************************/
void FlashWriteAddr2Byte(uint32 Addr)
{
 uint i;
 
 //????11?
 Addr=Addr&(FLASH_PAGE_SIZE-1);

 for(i=0;i<2;i++)     //????????
 {
  FlashWriteAddr(Addr);
  Addr>>=8;
 }

}
/////////////////////////End of function////////////////////////////

/********************************************************************
????:?FLASH????????????
????:Addr:?????????
?    ?:??
?    ?:
********************************************************************/
void FlashWritePageAddr(uint32 Addr)
{
 uint i;
 
 //?????
 Addr/=FLASH_PAGE_SIZE;

 for(i=0;i<2;i++) //????????
 {
  FlashWriteAddr(Addr); //??????
  Addr>>=8;
 }
}
/////////////////////////End of function////////////

/********************************************************************
????:Flash???
????:??
?    ?:??
?    ?:
********************************************************************/
void FlashReset(void)
{
 FlashWriteCommand(0xFF); //?????
 FlashWait();  //??????
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:Flash????
????:??
?    ?:??
?    ?:??
********************************************************************/
void FlashInit(void)
{
 FSMC_NAND_Init();	//FSMC INIT
 FlashReset(); //FLASH??
 FlashCurrentWriteSectorAddr=~0; //?????????????
 FlashCurrentReadSectorAddr=~0;
 FlashNeedWriteBack=0;  //???????
 FlashSwapBlockInit();  //??????
 FlashLoadBadBlockTable(); //?FLASH??????
}

/********************************************************************
????:????????
????:??
?    ?:??
?    ?:FLASH?????
********************************************************************/
uint8 FlashReadStatus(void)
{
 uint8 Status;
 FlashWriteCommand(0x70);  //?????
 Status  = *(uint8 *)(Bank_NAND_ADDR);  //????   
 return Status;
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:??????
????:Addr:?????
?    ?:??
?    ?:??
********************************************************************/
uint8 FlashEraseBlock(uint32 Addr)
{
 //??????????
 FlashWriteCommand(0x60);
 //?????????
 FlashWritePageAddr(Addr);
 //??????????
 FlashWriteCommand(0xD0);
 //??????
 FlashWait();
 //??????
 return FlashReadStatus();
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:??????????
????:??
?    ?:??
?    ?:??????
********************************************************************/
uint8 FlashWritePage(void)
{
 FlashWriteCommand(0x10);  //????
 FlashWait();  //?????
 return FlashReadStatus();
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:???????
????:sAddr:???;dAddr:?????
?    ?:??
?    ?:??????
********************************************************************/
uint8 FlashCopyPage(uint32 sAddr, uint32 dAddr)
{
 //?????????
 FlashWriteCommand(0x00);
 FlashWriteAddr4Byte(sAddr);
 FlashWriteCommand(0x35);
 FlashWait();
 
 //????????
 FlashWriteCommand(0x85);
 FlashWriteAddr4Byte(dAddr);
 FlashWriteCommand(0x10);
 FlashWait();
 return FlashReadStatus();
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:????????????
????:??
?    ?:???????
?    ?:?????????,????????????
********************************************************************/
uint32 FlashGetNewRemapBlock(void)
{
 uint32 i,Addr;
 for(i=0;i<FLASH_BAD_BLOCKS_REMAP;i++)
 {
  if(FLASH_BLOCK_OK==FlashRemapBlockStatus[i]) //???????
  {
   Addr=FLASH_BAD_BLOCK_REMAP_ADDR+i*FLASH_BLOCK_SIZE; //????
   if(0x01==(FlashEraseBlock(Addr)&0x01))  //??????
   {
    FlashRemapBlockStatus[i]=FLASH_BLOCK_BAD;  //?????????
   }
   else //??,????
   {
    FlashRemapBlockStatus[i]=FLASH_BLOCK_USED; //?????????    
    return Addr; //????
   }
  }
 }
 return ~0; //?????,???-1?
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:?????????????
????:Addr:?????????
?    ?:??
?    ?:??
********************************************************************/
void FlashMarkRemapBlockBad(uint32 Addr)
{
 uint32 i;
 i=(Addr-FLASH_BAD_BLOCK_REMAP_ADDR)/FLASH_BLOCK_SIZE;  //?????
 if(i>=FLASH_BAD_BLOCKS_REMAP)return; //??
 FlashRemapBlockStatus[i]=FLASH_BLOCK_BAD;  //???????
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:??????,??????
????:Addr:??????????
?    ?:?????????
?    ?:??
********************************************************************/
uint32 FlashAddrRemap(uint32 Addr)
{
 static uint32 CurrentRemapBlockAddr;
 uint32 i,j;
 
 if(0==FlashBadBlocksCount)  //???????0,??????,??????
 {
  return Addr;
 }
 
 //???????????????????????????,?????????
 if(0==((Addr-FlashLastAccessAddr)&(FLASH_BLOCK_SIZE-1)))
 {
  return CurrentRemapBlockAddr+(Addr&(FLASH_BLOCK_SIZE-1)); //??????????????????
 }
 
 FlashLastAccessAddr=Addr; //????????????
 
 if(1==FlashBadBlocksCount) //???????1,?????
 {
  if((Addr&(~(FLASH_BLOCK_SIZE-1)))==FlashBadBlockTable[0][0]) //???????,?????
  {
   CurrentRemapBlockAddr=FlashBadBlockTable[1][0];
   return CurrentRemapBlockAddr+(Addr&(FLASH_BLOCK_SIZE-1)); //??????????????????
  }
  else //????
  {
   CurrentRemapBlockAddr=Addr&(~(FLASH_BLOCK_SIZE-1));  //???????
   return Addr;  //?????????
  }
 }
 else //??????1
 {
  //?????????????????????????????,
  //?????????,???????
  if((Addr<FlashBadBlockTable[0][0])
   ||((Addr&(FLASH_BLOCK_SIZE-1))>FlashBadBlockTable[0][FlashBadBlocksCount-1]))
  {
   CurrentRemapBlockAddr=Addr&(~(FLASH_BLOCK_SIZE-1));  //???????
   return Addr;  //?????????
  }
  else //??????,???????????????
  {
   i=0;
   j=FlashBadBlocksCount-1;
   while(1)
   {
    if((Addr&(~(FLASH_BLOCK_SIZE-1)))==FlashBadBlockTable[0][(i+j)/2]) //????,???
    {
     CurrentRemapBlockAddr=FlashBadBlockTable[1][(i+j)/2];
     return CurrentRemapBlockAddr+(Addr&(FLASH_BLOCK_SIZE-1)); //??????????????????
    }
    if(i==j)break; //??i?j??,?????
    if((Addr&(~(FLASH_BLOCK_SIZE-1)))<FlashBadBlockTable[0][(i+j)/2])  //????
    {
     j=(i+j)/2-1; //?????
    }
    else //????
    {
     i=(i+j)/2+1; //?????
    }
   }
  }
 }
 //?????????,???????
 CurrentRemapBlockAddr=Addr&(~(FLASH_BLOCK_SIZE-1));  //???????
 return Addr;  //?????????
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:?FLASH???????????
????:??
?    ?:??
?    ?:??
********************************************************************/
void FlashLoadBadBlockTable(void)
{
 uint32 i,j,k,Sum,Ok;
 uint8 Data;

 Ok=0; //??????
 for(i=0;i<FLASH_BLOCKS_TABLE;i++) //??????????
 {
  //??????????????,????0xFF,???0xFF,??????????
  FlashWriteCommand(0x00);
  FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*(i+1) - FLASH_PAGE_SIZE);
  FlashWriteCommand(0x30);
  FlashWait(); //??????
  Data = FlashReadDataByte();
  if(Data==0xFF)  //????????????
  {
   //???????????????,????0,???0,???????????
   FlashWriteCommand(0x00);
   FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*(i+1) - 2*FLASH_PAGE_SIZE);
   FlashWriteCommand(0x30);
   FlashWait(); //??????
   Data = FlashReadDataByte();
   if(Data==0) //??????
   {
    Data = FlashReadDataByte(); //?????
    Sum=Data;
    Data = FlashReadDataByte(); //?????
    Sum=(Sum<<8)+Data;
    Data = FlashReadDataByte();//?????
    Sum=(Sum<<8)+Data;
    Data = FlashReadDataByte();//?????
    Sum=(Sum<<8)+Data;
    //????????
    FlashWriteCommand(0x00);
    FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i);
    FlashWriteCommand(0x30);
    FlashWait(); //??????
    //???1?????0
    Data = FlashReadDataByte();
    if(Data!=0)continue;
    //???2?????0x55
    Data = FlashReadDataByte();
    if(Data!=0x55)continue;
    //???3?????0xAA
    Data = FlashReadDataByte();
    if(Data!=0xAA)continue;
    //???4?????0xFF
    Data = FlashReadDataByte();
    if(Data!=0xFF)continue;
    Sum+=0x1FE;
    
    //?????
    Data = FlashReadDataByte();
    FlashBadBlocksCount=Data;
    Sum+=Data;
    Data = FlashReadDataByte();
    FlashBadBlocksCount=(FlashBadBlocksCount<<8)+Data;
    Sum+=Data;
    Data = FlashReadDataByte();
    FlashBadBlocksCount=(FlashBadBlocksCount<<8)+Data;
    Sum+=Data;
    Data = FlashReadDataByte();
    FlashBadBlocksCount=(FlashBadBlocksCount<<8)+Data;
    Sum+=Data;
    j=8;
    //?????
    for(k=0;k<sizeof(FlashBadBlockTable[0][0])*FLASH_BAD_BLOCKS_REMAP*2;k++)
    {
     if(0==(j&(FLASH_PAGE_SIZE-1))) //??????,????????
     {
      FlashWriteCommand(0x00);
      FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i+j);
      FlashWriteCommand(0x30);
      FlashWait(); //??????
     }
     Data = FlashReadDataByte();
     Sum+=Data; //????
     ((uint8 *)FlashBadBlockTable)[k]=Data;  //??????????
     j++;
    }
    //??????????
    for(k=0;k<sizeof(FlashRemapBlockStatus[0])*FLASH_BAD_BLOCKS_REMAP;k++)
    {
     if(0==(j&(FLASH_PAGE_SIZE-1))) //??????,????????
     {
      FlashWriteCommand(0x00);
      FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i+j);
      FlashWriteCommand(0x30);
      FlashWait(); //??????
     }
     Data = FlashReadDataByte();
     Sum+=Data; //????
     ((uint8 *)FlashRemapBlockStatus)[k]=Data;   //??????????????
     j++;
    }
    if(Sum==0) //??????,???????
    {
     Ok=0xFF; //?????
     break;   //?????
    }
   }
  }
 }
 
 if(Ok==0) //?????????????????,??????????
 {
  for(i=0;i<FLASH_BLOCKS_TABLE;i++) //????????
  {
   //??????????????,????0,???0,???????????
   FlashWriteCommand(0x00);
   FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*(i+1) - FLASH_PAGE_SIZE);
   FlashWriteCommand(0x30);
   FlashWait(); //??????
   Data = FlashReadDataByte();
   if(Data==0x00)  //??????????
   {
    //???????????????,????0,???0,???????????
    FlashWriteCommand(0x00);
    FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*(i+1) - 2*FLASH_PAGE_SIZE);
    FlashWriteCommand(0x30);
    FlashWait(); //??????
    Data = FlashReadDataByte();
    if(Data==0) //??????
    {
     Data = FlashReadDataByte(); //?????
     Sum=Data;
     Data = FlashReadDataByte(); //?????
     Sum=(Sum<<8)+Data;
     Data = FlashReadDataByte(); //?????
     Sum=(Sum<<8)+Data;
     Data = FlashReadDataByte(); //?????
     Sum=(Sum<<8)+Data;
     //????????
     FlashWriteCommand(0x00);
     FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i);
     FlashWriteCommand(0x30);
     FlashWait(); //??????
     //???1?????0
     Data = FlashReadDataByte();
     if(Data!=0)continue;
     //???2?????0x55
     Data = FlashReadDataByte();
     if(Data!=0x55)continue;
     //???3?????0xAA
     Data = FlashReadDataByte();
     if(Data!=0xAA)continue;
     //???4?????0xFF
     Data = FlashReadDataByte();
     if(Data!=0xFF)continue;
     Sum+=0x1FE;
     
     //?????
     Data = FlashReadDataByte();
     FlashBadBlocksCount=Data;
     Sum+=Data;
     Data = FlashReadDataByte();
     FlashBadBlocksCount=(FlashBadBlocksCount<<8)+Data;
     Sum+=Data;
     Data = FlashReadDataByte();
     FlashBadBlocksCount=(FlashBadBlocksCount<<8)+Data;
     Sum+=Data;
     Data = FlashReadDataByte();
     FlashBadBlocksCount=(FlashBadBlocksCount<<8)+Data;
     Sum+=Data;
     j=8;
     //?????
     for(k=0;k<sizeof(FlashBadBlockTable[0][0])*FLASH_BAD_BLOCKS_REMAP*2;k++)
     {
      if(0==(j&(FLASH_PAGE_SIZE-1))) //??????,????????
      {
       FlashWriteCommand(0x00);
       FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i+j);
       FlashWriteCommand(0x30);
       FlashWait(); //??????
      }
      Data = FlashReadDataByte();
      Sum+=Data; //????
      ((uint8 *)FlashBadBlockTable)[k]=Data;  //??????????
      j++;
     }
     //??????????
     for(k=0;k<sizeof(FlashRemapBlockStatus[0])*FLASH_BAD_BLOCKS_REMAP;k++)
     {
      if(0==(j&(FLASH_PAGE_SIZE-1))) //??????,????????
      {
       FlashWriteCommand(0x00);
       FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i+j);
       FlashWriteCommand(0x30);
       FlashWait(); //??????
      }
      Data = FlashReadDataByte();
      Sum+=Data; //????
      ((uint8 *)FlashRemapBlockStatus)[k]=Data;   //??????????????
      j++;
     }
     if(Sum==0) //??????,???????
     {
      FlashSaveBadBlockTable(); //?????FLASH?      
      Ok=0xFF; //?????
      break;   //?????
     }
    }
   }
  }
 }
 
 if(Ok==0) //???????,??????????
 {
  FlashBadBlocksCount=0; //??????0
  for(i=0;i<FLASH_BAD_BLOCKS_REMAP;i++)
  {
   //???????????
   FlashRemapBlockStatus[i]=FLASH_BLOCK_OK;
   //?????????-1
   FlashBadBlockTable[0][i]=~0;
   FlashBadBlockTable[1][i]=~0;
  }
  //?????????
  FlashSaveBadBlockTable();
 }
 //??????????????
 FlashLastAccessAddr=~0;
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:??????FLASH??????
????:??
?    ?:??
?    ?:??
********************************************************************/
void FlashSaveBadBlockTable(void)
{
 uint32 i,j,k,Sum;
 
 for(i=0;i<FLASH_BLOCKS_TABLE;i++) //???????
 {
  FlashWriteCommand(0x80);
  FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*(i+1) - FLASH_PAGE_SIZE);
  FlashWriteDataByte(0x00);  //????????0,??????
  //?????0xFF
  for(j=1;j<FLASH_PAGE_SIZE;j++)
  {
   FlashWriteDataByte(0xFF);
  }
  FlashWritePage(); //??
 }
 
 for(i=0;i<FLASH_BLOCKS_TABLE;i++) //?????????
 {
  FlashEraseBlock(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i); //????
  FlashWriteCommand(0x80);
  FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i); //??????????
  FlashWriteDataByte(0x00);  //??1?????0
  FlashWriteDataByte(0x55);  //??2?????0x55
  FlashWriteDataByte(0xAA);  //??3?????0xAA
  FlashWriteDataByte(0xFF);  //??4?????0xFF
  Sum=0x1FE;
  //???????,??????
  FlashWriteDataByte((FlashBadBlocksCount>>24)&0xFF);
  Sum+=(FlashBadBlocksCount>>24)&0xFF;
  FlashWriteDataByte((FlashBadBlocksCount>>16)&0xFF);
  Sum+=(FlashBadBlocksCount>>16)&0xFF;
  FlashWriteDataByte((FlashBadBlocksCount>>8)&0xFF);
  Sum+=(FlashBadBlocksCount>>8)&0xFF;
  FlashWriteDataByte((FlashBadBlocksCount)&0xFF);
  Sum+=(FlashBadBlocksCount)&0xFF;
  j=8; //??8??
  //?????
  for(k=0;k<sizeof(FlashBadBlockTable[0][0])*FLASH_BAD_BLOCKS_REMAP*2;k++)
  {
   if(0==(j&(FLASH_PAGE_SIZE-1))) //??????,????????
   {
    FlashWritePage(); //??
    FlashWriteCommand(0x80);
    FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i + j);
   }
   Sum+=((uint8 *)FlashBadBlockTable)[k]; //????
   FlashWriteDataByte(((uint8 *)FlashBadBlockTable)[k]);  //????
   j++;
  }
  //??????????
  for(k=0;k<sizeof(FlashRemapBlockStatus[0])*FLASH_BAD_BLOCKS_REMAP;k++)
  {
   if(0==(j&(FLASH_PAGE_SIZE-1))) //??????,????????
   {
    FlashWritePage(); //??
    FlashWriteCommand(0x80);
    FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*i + j);
   }
   Sum+=((uint8 *)FlashRemapBlockStatus)[k]; //????
   FlashWriteDataByte(((uint8 *)FlashRemapBlockStatus)[k]);  //????
   j++;
  }
  for(;0!=(j&(FLASH_PAGE_SIZE-1));j++) //???????0xFF
  {
   FlashWriteDataByte(0xFF);
  }
  FlashWritePage();   //??
  
  //?????????????????????
  FlashWriteCommand(0x80);
  FlashWriteAddr4Byte(FLASH_BLOCK_TABLE_ADDR + FLASH_BLOCK_SIZE*(i+1) - 2*FLASH_PAGE_SIZE);
  FlashWriteDataByte(0x00);  //????????0,??????
  //???????1,????????0
  Sum=(~Sum)+1;
  //????
  FlashWriteDataByte((Sum>>24)&0xFF);
  FlashWriteDataByte((Sum>>16)&0xFF);
  FlashWriteDataByte((Sum>>8)&0xFF);
  FlashWriteDataByte((Sum)&0xFF);
  //?????0xFF
  for(j=5;j<FLASH_PAGE_SIZE;j++)
  {
   FlashWriteDataByte(0xFF);
  }
  FlashWritePage(); //??
 }
}
/////////////////////////End of function/////////////////////////////


/********************************************************************
????:??????
????:OldAddr:???;NewAddr:????????
?    ?:??
?    ?:??
********************************************************************/
void FlashUpdateBadBlockTable(uint32 OldAddr,uint32 NewAddr)
{
 uint32 i,j;
 OldAddr&=~(FLASH_BLOCK_SIZE-1); //?????????
 NewAddr&=~(FLASH_BLOCK_SIZE-1);
 if(OldAddr>FLASH_MAX_SECTOR_ADDR) //??????????????,?????????????????
 {
  //????????????
  for(i=0;i<FlashBadBlocksCount;i++)
  {
   if(OldAddr==FlashBadBlockTable[1][i]) //?????????,?????????
   {
    FlashBadBlockTable[1][i]=NewAddr; //?????????
    //??????????????
    FlashMarkRemapBlockBad(OldAddr);
    break;
   }
  }
 }
 else //??????????????
 {
  //?????????,???????,???,??????
  for(i=0;i<FlashBadBlocksCount;i++) 
  {
   if(OldAddr<FlashBadBlockTable[0][i]) //????????
   {
    break;
   }
  }
  for(j=FlashBadBlocksCount;j>i;j--) //??????????,??????
  {
   FlashBadBlockTable[0][j]=FlashBadBlockTable[0][j-1];
   FlashBadBlockTable[1][j]=FlashBadBlockTable[1][j-1];
  }
  //?????????
  FlashBadBlockTable[0][j]=OldAddr;
  FlashBadBlockTable[1][j]=NewAddr;
  FlashBadBlocksCount++; //????????
 }
 FlashSaveBadBlockTable(); //?????
 //???????????????,?????????????
 FlashLastAccessAddr=~0;
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:FLASH?????
????:Addr: ?????
?    ?:??
?    ?:???????
********************************************************************/
uint32 FlashDealBadBlock(uint32 Addr, uint32 Type)
{
 uint32 i;
 uint32 RemapBlockAddr;
 uint32 SwapBlockAddr;
 while(1)
 {
  RemapBlockAddr=FlashGetNewRemapBlock();
  if(RemapBlockAddr==~0)  //???????????????,?????????
  {
   return Addr;
  }
  switch(Type)
  {
   //????????,??????????????
   //?????????????????????,??????
   case 1:
    goto Exit;
//   break;
   
   //?????????,???????????????????????
   case 2:
   //??????????????????
   SwapBlockAddr=FlashGetCurrentSwapBlock();  //???????????
   //?????????
   for(i=0;i<(Addr&(FLASH_BLOCK_SIZE-1))/FLASH_PAGE_SIZE+1;i++)
   {
    if(0x01==(FlashCopyPage(SwapBlockAddr+i*FLASH_PAGE_SIZE,RemapBlockAddr+i*FLASH_PAGE_SIZE)&0x01))
    {
     //??????,????????,??????
     goto BadRemapBlock;
    }
   }
   //????,?????
   goto Exit;
//   break;
   
   //?????????,???????????????????,
   //?????????????????????????????
   //???????????????,?????????????
   case 3:  
   //????????????
   SwapBlockAddr=FlashGetCurrentSwapBlock();  //???????????
   //??????
   for(i=0;i<(Addr&(FLASH_BLOCK_SIZE-1))/FLASH_PAGE_SIZE;i++)
   {
    if(0x01==(FlashCopyPage(SwapBlockAddr+i*FLASH_PAGE_SIZE,RemapBlockAddr+i*FLASH_PAGE_SIZE)&0x01))
    {
     //??????,????????,??????
     goto BadRemapBlock;
    }
   }
   //?????,???????????????
   if(0x01==(FlashCopyPage(Addr,RemapBlockAddr+i*FLASH_PAGE_SIZE)&0x01))
   {
    //??????,????????,??????
    goto BadRemapBlock;
   }   
   //????,?????
   goto Exit;
//   break;
   
   default:
   break;
  }
  BadRemapBlock:
  //?????????,??????????
  FlashMarkRemapBlockBad(RemapBlockAddr);
 }
 Exit:
 //?????
 FlashUpdateBadBlockTable(Addr,RemapBlockAddr);
 return RemapBlockAddr+(Addr&(FLASH_BLOCK_SIZE-1));
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:???????????
????:Op:??????
?    ?:?????????????
?    ?:??
********************************************************************/
uint32 FlashManageSwapBlock(uint32 Op)
{
 static uint32 Current;
 static uint8 FlashSwapBlockStatus[FLASH_SWAP_BLOCKS];
 uint32 i;
 
 switch(Op)
 {
  case 0:  //?????1,?????
   Current=0;
   for(i=0;i<FLASH_SWAP_BLOCKS;i++)
   {
    FlashSwapBlockStatus[i]=0; //???????????
   }
  break;
  
  case 1: //?????1,?????????????
   while(1)//????,????????(?)?,???????,
   {
    Current++;
    if(Current>=FLASH_SWAP_BLOCKS)
    {
     Current=0;
    }
    if(FlashSwapBlockStatus[Current]==0)break; //???????0,??????
   }
  break;
  
  case 2: //?????2,???????????
  break;
  
  case 3: //?????3,??????????
   FlashSwapBlockStatus[Current]=FLASH_BLOCK_BAD;
  break;
  
  default:
  break;
 }
 return FLASH_SWAP_BLOCK_ADDR+Current*FLASH_BLOCK_SIZE; //??????????
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:?????????????????????,
          ?????Addr????????????????
????:Addr:??????????
?    ?:???????
?    ?:???????????,????,
          ????????????,?????????????
          ???????????????????
********************************************************************/
uint32 FlashCopyBlockToSwap(uint32 Addr)
{
 uint32 SwapAddr;
 uint32 i;
 uint32 BlockStartAddr;
 
 BlockStartAddr=(Addr)&(~(FLASH_BLOCK_SIZE-1));  //???????
 
 while(1)
 {
  SwapAddr=FlashGetNextSwapBlock(); //????????
  if(0x00==(FlashEraseBlock(SwapAddr)&0x01)) //??????
  {
   for(i=0;i<FLASH_BLOCK_SIZE/FLASH_PAGE_SIZE;i++)  //???????????????
   {
    //????
    if(0x01&FlashCopyPage(BlockStartAddr+i*FLASH_PAGE_SIZE,SwapAddr+i*FLASH_PAGE_SIZE))
    {
     //??????,???????????,???????????
     goto BadSwapBlock;
    }
   }
   //??????,????????
   if(0x01==(FlashEraseBlock(BlockStartAddr)&0x01)) //??????
   {
    Addr=FlashDealBadBlock(Addr,1); //??????????
    BlockStartAddr=(Addr)&(~(FLASH_BLOCK_SIZE-1));  //???????
   }
   //???????????????
   for(i=0;i<(Addr-BlockStartAddr)/FLASH_PAGE_SIZE;i++)
   {
    //????
    if(0x01&FlashCopyPage(SwapAddr+i*FLASH_PAGE_SIZE,BlockStartAddr+i*FLASH_PAGE_SIZE))
    {
     //??????,??????
     //??FlashDealBadBlock???????????????,
     //??????????Addr???????????????
     Addr=(FlashDealBadBlock(BlockStartAddr+i*FLASH_PAGE_SIZE,2)&(~(FLASH_BLOCK_SIZE-1)))
         +(Addr&(FLASH_BLOCK_SIZE-1));
     BlockStartAddr=(Addr)&(~(FLASH_BLOCK_SIZE-1));  //???????
    }
   }
   return Addr; //????,??
  }
  else //??,????
  {
   BadSwapBlock:
   //??????????
   FlashMarkBadCurrentSwapBlock();
  }
 }
// return Addr;
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:?FLASH??????(FLASH_SECTOR_SIZE??)?
????:Addr: ????;pBuf:????????;Remain:?????????????
?    ?:??????0:????0:???
?    ?:?Remain??0?,?????????????????!
          ????????,???Remain?0,??????
********************************************************************/
uint32 FlashWriteOneSector(uint32 Addr, uint8 * pBuf, uint32 Remain)
{
 uint32 i;
 uint32 SwapPageAddr;
// printf("Addr = 0x%x\r\n",Addr);
// printf("Remain = 0x%x\r\n",Remain);
 
 if(Addr>FLASH_MAX_SECTOR_ADDR)return 1; //????????,???????1,??
 Addr=FlashAddrRemap(Addr); //??????
 if((Addr&(~(FLASH_PAGE_SIZE-1)))!=(FlashCurrentWriteSectorAddr&(~(FLASH_PAGE_SIZE-1)))) //???page
 {
//  printf("??\r\n");
  if(FlashNeedWriteBack) //????????,?????????page??
  {
   if(FlashWritePage()&0x01) //????
   {
    Addr=FlashDealBadBlock(Addr-FLASH_PAGE_SIZE,3)+FLASH_PAGE_SIZE;  //????
   }
  }
  if((Addr&(~(FLASH_BLOCK_SIZE-1)))!=(FlashCurrentWriteSectorAddr&(~(FLASH_BLOCK_SIZE-1))))  //???block,????????,
  {
   //?????,?????????????,?????????????
   //??????????????????,???????????,??????????????
//   printf("??\r\n");
   Addr=FlashCopyBlockToSwap(Addr);
  }
  //????????????
  FlashWriteCommand(0x00);
  FlashWriteAddr4Byte(FlashGetCurrentSwapBlock()+(Addr&(FLASH_BLOCK_SIZE-1)));
  FlashWriteCommand(0x35);
  FlashWait();
  //???
  FlashWriteCommand(0x85);
  FlashWriteAddr4Byte(Addr); //?4????
  for(i=0;i<FLASH_SECTOR_SIZE;i++)
  {
   FlashWriteDataByte(pBuf[i]);
  }
  FlashNeedWriteBack=1; //????
 }

 else  //????????,??????
 {
  //???
//  printf("???\r\n");
  FlashWriteCommand(0x85);
  FlashWriteAddr2Byte(Addr);
  for(i=0;i<FLASH_SECTOR_SIZE;i++)
  {
   FlashWriteDataByte(pBuf[i]);
  }
  FlashNeedWriteBack=1; //????
 }
 FlashCurrentWriteSectorAddr=Addr; //?????? 
 if(Remain==0) //??????0,?????,????
 {
//  printf("??\r\n");
  if(FlashNeedWriteBack) //????????,?????????page??
  {
   if(FlashWritePage()&0x01) //????
   {
    Addr=FlashDealBadBlock(Addr,3);  //????
   }
  }
  //??????
  Remain=(((Addr+FLASH_BLOCK_SIZE)&(~(FLASH_BLOCK_SIZE-1)))-(Addr&(~(FLASH_PAGE_SIZE-1))))/FLASH_PAGE_SIZE-1;
  //?????????????
  SwapPageAddr=FlashGetCurrentSwapBlock()+(Addr&(FLASH_BLOCK_SIZE-1));
  
  for(i=0;i<Remain;i++)  //????????????????????????
  {
   Addr+=FLASH_PAGE_SIZE;   //???????
   SwapPageAddr+=FLASH_PAGE_SIZE;   
   if(0x01==(FlashCopyPage(SwapPageAddr,Addr)&0x01)) //??????
   {
    Addr=FlashDealBadBlock(Addr,2);  //????
   }
  }
  FlashNeedWriteBack=0; //????????
  FlashCurrentWriteSectorAddr=~0;
 }
 return 0;
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:?FLASH????????????????
????:Addr: ????;pBuf:????????;Remain:?????????????
?    ?:??????0:????0:???
?    ?:?Remain??0?,??????????????????,???0?,
          ??????????,???????????????????flash????????
********************************************************************/
uint32 FlashReadOneSector(uint32 Addr, uint8  *pBuf, uint32 Remain)
{
 uint32 i;
 if(Addr>FLASH_MAX_SECTOR_ADDR)return 1; //????????,???????1,??
 Addr=FlashAddrRemap(Addr); //??????
 if((Addr&(~(FLASH_PAGE_SIZE-1)))
    !=(FlashCurrentReadSectorAddr&(~(FLASH_PAGE_SIZE-1)))) //???page
 {
  //?????,???????
  FlashWriteCommand(0x00);
  FlashWriteAddr4Byte(Addr);
  FlashWriteCommand(0x30);
  FlashWait(); //??????
 }
 else
 {
  //??????,??????
  FlashWriteCommand(0x05);
  FlashWriteAddr2Byte(Addr);
  FlashWriteCommand(0xE0);
  FlashWait(); //??????
 }
 for(i=0;i<FLASH_SECTOR_SIZE;i++)
 {
   pBuf[i]=FlashReadDataByte();  //??????
 }
 FlashCurrentReadSectorAddr=Addr; //?????????
 if(Remain==0) //???????,????????????????
 {
  FlashCurrentReadSectorAddr=~0;
 }

 return 0;
}
/////////////////////////End of function/////////////////////////////

/********************************************************************
????:?FLASH?ID??
????:Buf:??ID??????
?    ?:??
?    ?:??
********************************************************************/
void FlashReadId(uint8 *Buf)
{
 uint8 i;
 FlashWriteCommand(0x90);
 FlashWriteAddr(0); //???

 for(i=0;i<5;i++)  //?5???ID
 {
  Buf[i]=FlashReadDataByte();
 }
}
/////////////////////////End of function/////////////////////////////



/******************* (C) COPYRIGHT 2008 STMicroelectronics *****END OF FILE****/
